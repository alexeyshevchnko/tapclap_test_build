window.__require=function e(t,o,r){function i(a,c){if(!o[a]){if(!t[a]){var s=a.split("/");if(s=s[s.length-1],!t[s]){var l="function"==typeof __require&&__require;if(!c&&l)return l(s,!0);if(n)return n(s,!0);throw new Error("Cannot find module '"+a+"'")}a=s}var u=o[a]={exports:{}};t[a][0].call(u.exports,function(e){return i(t[a][1][e]||e)},u,u.exports,e,t,o,r)}return o[a].exports}for(var n="function"==typeof __require&&__require,a=0;a<r.length;a++)i(r[a]);return i}({AsyncUtils:[function(e,t,o){"use strict";cc._RF.push(t,"da4b52gKKtJQoCrHyfP/08r","AsyncUtils"),Object.defineProperty(o,"__esModule",{value:!0}),o.delay=void 0,o.delay=function(e){return new Promise(function(t){return setTimeout(t,e)})},cc._RF.pop()},{}],BoardModel:[function(e,t,o){"use strict";cc._RF.push(t,"e832d0fpl9JKapDArSU1Ntq","BoardModel"),Object.defineProperty(o,"__esModule",{value:!0}),o.BoardModel=void 0;var r=function(){function e(e,t){this.rows=e,this.cols=t,this.tiles=[],this.tiles=[];for(var o=0;o<this.rows;o++){this.tiles[o]=[];for(var r=0;r<this.cols;r++)this.tiles[o][r]=null}}return e.prototype.getTile=function(e,t){var o,r;return t<0||t>=this.rows||e<0||e>=this.cols?null:null!==(r=null===(o=this.tiles[t])||void 0===o?void 0:o[e])&&void 0!==r?r:null},e.prototype.setTile=function(e,t,o){t<0||t>=this.rows||e<0||e>=this.cols||(this.tiles[t]||(this.tiles[t]=new Array(this.cols).fill(null)),this.tiles[t][e]=o)},e}();o.BoardModel=r,cc._RF.pop()},{}],BoardService:[function(e,t,o){"use strict";cc._RF.push(t,"ea581/6uoBNuai4UWaH0dUD","BoardService"),Object.defineProperty(o,"__esModule",{value:!0}),o.BoardService=void 0;var r=function(){function e(e,t){var o=this;this.model=e,this.factory=t,this.cols=function(){return o.model.cols},this.rows=function(){return o.model.rows}}return e.prototype.generateBoard=function(){for(var e=0;e<this.model.rows;e++)for(var t=0;t<this.model.cols;t++)this.model.setTile(t,e,this.factory.create(t,e,!1))},e.prototype.removeTiles=function(e){for(var t=0,o=e;t<o.length;t++)o[t].isRemoved=!0},e.prototype.collapse=function(){for(var e,t=0;t<this.model.cols;t++)for(var o=0;o<this.model.rows-1;o++)if(null===(e=this.model.getTile(t,o))||void 0===e?void 0:e.isRemoved)for(var r=o+1;r<this.model.rows;r++){var i=this.model.getTile(t,r);if(i&&!i.isRemoved){this.swap(t,o,t,r);break}}},e.prototype.spawnNew=function(){for(var e,t=[],o=0;o<this.model.cols;o++){for(var r=[],i=0;i<this.model.rows;i++)(null===(e=this.model.getTile(o,i))||void 0===e?void 0:e.isRemoved)&&r.push(i);r.sort(function(e,t){return e-t});for(var n=0;n<r.length;n++){i=r[n];var a=this.factory.create(o,i,!1);this.model.setTile(o,i,a),t.push({tile:a,fromY:this.model.rows+n})}}return t},e.prototype.swap=function(e,t,o,r){var i=this.model.getTile(e,t),n=this.model.getTile(o,r);this.model.setTile(e,t,n),this.model.setTile(o,r,i),i&&(i.x=o,i.y=r),n&&(n.x=e,n.y=t)},e.prototype.createRandomSpecialTile=function(e,t){var o=this.factory.createRandomSpecial(e,t);return o&&this.model.setTile(e,t,o),o},e.prototype.getRemovedTiles=function(){for(var e=[],t=0;t<this.model.rows;t++)for(var o=0;o<this.model.cols;o++){var r=this.model.getTile(o,t);r.isRemoved&&e.push(r)}return e},e.prototype.getTile=function(e,t){return this.model.getTile(e,t)},e.prototype.setTile=function(e,t,o){this.model.setTile(e,t,o)},e}();o.BoardService=r,cc._RF.pop()},{}],BoardView:[function(e,t,o){"use strict";cc._RF.push(t,"14e023Vr8xNg75fHy9dw+PD","BoardView");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(o,"__esModule",{value:!0});var a=cc._decorator,c=a.ccclass,s=a.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tilePrefab=null,t.offset=cc.v2(0,0),t.tileNodes=[],t}return i(t,e),t.prototype.init=function(e,t){this.controller=e,this.boardModel=t,this.generateBoard()},t.prototype.generateBoard=function(){this.tileNodes=[],this.node.removeAllChildren();for(var e=0;e<this.boardModel.rows;e++){this.tileNodes[e]=[];for(var t=0;t<this.boardModel.cols;t++){var o=this.boardModel.getTile(t,e);o&&this.createTileNode(o,t,e)}}},t.prototype.RemoveTileNode=function(e,t){this.tileNodes[t][e]=null},t.prototype.getTileNode=function(e,t){return t<0||t>=this.tileNodes.length?null:e<0||e>=this.tileNodes[t].length?null:this.tileNodes[t][e]||null},t.prototype.createTileNode=function(e,t,o){var r=cc.instantiate(this.tilePrefab);r.parent=this.node,r.position=this.getTilePosition(t,o),r.zIndex=o,r._tileModel=e;var i=r.getComponent("TileView"),n=window.TileSpriteFrames[e.id];return i.bindModel(e,this.controller,n),this.tileNodes[o][t]=r,r},t.prototype.getTilePosition=function(e,t){return cc.v3(100*e+this.offset.x,100*t+this.offset.y,0)},t.prototype.spawnTiles=function(e){for(var t=[],o=0,r=e;o<r.length;o++){var i=r[o],n=i.x,a=i.y;t[a]||(t[a]=[]);var c=this.createTileNode(i,n,a);t[a][n]=c,this.tileNodes[a][n]=c}return t},t.prototype.updateTileNodesStructure=function(){for(var e=Array(this.boardModel.rows).fill(null).map(function(){return[]}),t=0;t<this.boardModel.rows;t++)for(var o=0;o<this.boardModel.cols;o++){var r=this.boardModel.getTile(o,t);if(r){var i=this.findExistingNodeForTile(r);i&&(e[t][o]=i)}}this.tileNodes=e},t.prototype.findExistingNodeForTile=function(e){for(var t,o=0;o<this.tileNodes.length;o++)for(var r=0;r<(null===(t=this.tileNodes[o])||void 0===t?void 0:t.length);r++){var i=this.tileNodes[o][r];if(i&&i._tileModel===e)return this.tileNodes[o][r]=null,i}return null},n([s(cc.Prefab)],t.prototype,"tilePrefab",void 0),n([s(cc.Vec2)],t.prototype,"offset",void 0),n([c],t)}(cc.Component);o.default=l,cc._RF.pop()},{}],GameConfig:[function(e,t,o){"use strict";cc._RF.push(t,"b63d2Ld50xCDaFQtk7eup2q","GameConfig"),Object.defineProperty(o,"__esModule",{value:!0}),o.default={rows:8,cols:8,tileSize:100},cc._RF.pop()},{}],GameManager:[function(e,t,o){"use strict";cc._RF.push(t,"6f258jAIY5EKLDO4MlGi0WI","GameManager");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(o,"__esModule",{value:!0});var a=cc._decorator,c=a.ccclass,s=a.property,l=e("./Views/GameView"),u=e("./Views/BoardView"),p=e("./UIManager"),f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.boardView=null,t.uiManager=null,t.gameView=null,t}return i(t,e),t.prototype.onLoad=function(){this.gameView=this.getComponent(l.default)||this.addComponent(l.default),this.boardView&&(this.gameView.boardView=this.boardView),this.ui&&(this.gameView.uiManager=this.uiManager)},n([s(u.default)],t.prototype,"boardView",void 0),n([s(p.default)],t.prototype,"uiManager",void 0),n([c],t)}(cc.Component);o.default=f,cc._RF.pop()},{"./UIManager":"UIManager","./Views/BoardView":"BoardView","./Views/GameView":"GameView"}],GameModel:[function(e,t,o){"use strict";cc._RF.push(t,"3492chkFSVJo5zFLChWQCbP","GameModel"),Object.defineProperty(o,"__esModule",{value:!0}),o.GameModel=void 0;o.GameModel=function(){this.state="idle",this.moves=0,this.score=0},cc._RF.pop()},{}],GameService:[function(e,t,o){"use strict";cc._RF.push(t,"cef48tdenJMZIkMAOhwVqW1","GameService"),Object.defineProperty(o,"__esModule",{value:!0}),o.GameService=void 0;var r=function(){function e(e,t){this.model=e,this.scoreService=t}return e.prototype.start=function(){this.model.state="running"},e.prototype.useMove=function(){"running"===this.model.state&&(this.model.moves--,this.model.moves<=0&&(this.model.state="gameover"))},e.prototype.addScore=function(e){this.scoreService.add(e),this.model.score=this.scoreService.getScore()},e}();o.GameService=r,cc._RF.pop()},{}],GameTypes:[function(e,t,o){"use strict";cc._RF.push(t,"83847sMzpJI0r9jgtgjS2Lz","GameTypes"),Object.defineProperty(o,"__esModule",{value:!0}),cc._RF.pop()},{}],GameView:[function(e,t,o){"use strict";cc._RF.push(t,"874f13t+LRPzpLWWSNJgNwK","GameView");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a},a=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(t){n(t)}}function c(e){try{s(r.throw(e))}catch(t){n(t)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})},c=this&&this.__generator||function(e,t){var o,r,i,n,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function c(e){return function(t){return s([e,t])}}function s(n){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(i=2&n[0]?r.return:n[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,n[1])).done)return i;switch(r=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){a.label=n[1];break}if(6===n[0]&&a.label<i[1]){a.label=i[1],i=n;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(n);break}i[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(c){n=[6,c],r=0}finally{o=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}};Object.defineProperty(o,"__esModule",{value:!0});var s=cc._decorator,l=s.ccclass,u=s.property,p=e("./BoardView"),f=e("../../Core/Board/BoardModel"),h=e("../../Core/Board/BoardService"),d=e("../../Core/Tiles/TileFactory"),v=e("../Animations/TileAnimator"),y=e("../../Core/Game/GameModel"),b=e("../../Core/Game/GameService"),m=e("../../Core/Scoring/ScoreService"),w=e("../../Core/Scoring/ScoreModel"),g=e("../../Infrastructure/Config/GameConfig"),_=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.boardView=null,t}return i(t,e),t.prototype.onLoad=function(){var e=window.TileConfigs||{};this.tileFactory=new d.TileFactory(e),this.boardModel=new f.BoardModel(g.default.rows,g.default.cols),this.boardService=new h.BoardService(this.boardModel,this.tileFactory),this.boardService.generateBoard(),this.boardView.init(this,this.boardModel),this.animator=new v.TileAnimator(this.boardView,this.boardModel,this.boardService),this.initAllBehaviors(this.boardService,this.animator),this.gameModel=new y.GameModel;var t=new w.ScoreModel;this.scoreService=new m.ScoreService(t),this.gameService=new b.GameService(this.gameModel,this.scoreService),this.gameService.start()},t.prototype.initAllBehaviors=function(e,t){for(var o=window.TileConfigs||{},r=0,i=Object.entries(o);r<i.length;r++){var n=i[r],a=n[0],c=n[1];if(c.behavior&&"function"==typeof c.behavior.init)try{console.log("Initializing behavior for tile: "+a),c.behavior.init(e,t)}catch(s){console.error("Error initializing behavior for tile "+a+":",s)}}},t.prototype.onTileClicked=function(e){return a(this,void 0,void 0,function(){var t,o;return c(this,function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),console.log("A1"),[4,e.behavior.execute(e)];case 1:return r.sent(),console.log("A2"),this.boardService.collapse(),[4,this.animator.animateCollapse()];case 2:return r.sent(),t=this.boardService.spawnNew(),[4,this.animator.animateSpawn(t)];case 3:return r.sent(),[3,5];case 4:return o=r.sent(),console.error("Error in tile chain reaction:",o),o instanceof Error&&console.error("Stack trace:",o.stack),[3,5];case 5:return[2]}})})},n([u(p.default)],t.prototype,"boardView",void 0),n([l],t)}(cc.Component);o.default=_,cc._RF.pop()},{"../../Core/Board/BoardModel":"BoardModel","../../Core/Board/BoardService":"BoardService","../../Core/Game/GameModel":"GameModel","../../Core/Game/GameService":"GameService","../../Core/Scoring/ScoreModel":"ScoreModel","../../Core/Scoring/ScoreService":"ScoreService","../../Core/Tiles/TileFactory":"TileFactory","../../Infrastructure/Config/GameConfig":"GameConfig","../Animations/TileAnimator":"TileAnimator","./BoardView":"BoardView"}],ScoreModel:[function(e,t,o){"use strict";cc._RF.push(t,"2bedcFb4PxMFYMpEzR5PDix","ScoreModel"),Object.defineProperty(o,"__esModule",{value:!0}),o.ScoreModel=void 0;o.ScoreModel=function(){this.score=0},cc._RF.pop()},{}],ScoreService:[function(e,t,o){"use strict";cc._RF.push(t,"84415ZiOcpANJpun4qwHtI2","ScoreService"),Object.defineProperty(o,"__esModule",{value:!0}),o.ScoreService=void 0;var r=function(){function e(e){this.model=e}return e.prototype.add=function(e){this.model.score+=e},e.prototype.getScore=function(){return this.model.score},e}();o.ScoreService=r,cc._RF.pop()},{}],ScriptableTileConfig:[function(e,t,o){"use strict";cc._RF.push(t,"7274cKrsDhHNr3NS3eNaZG7","ScriptableTileConfig");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(o,"__esModule",{value:!0});var a=e("../Core/Tiles/TileBehavior"),c=cc._decorator,s=c.ccclass,l=c.property,u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.rocketUpPrefab=null,t.rocketDownPrefab=null,t.rocketLeftPrefab=null,t.rocketRightPrefab=null,t.firePrefab=null,t.redSprite=null,t.blueSprite=null,t.greenSprite=null,t.bombSprite=null,t.purpureSprite=null,t.yellowSprite=null,t.roketVSprite=null,t.roketHSprite=null,t}return i(t,e),t.prototype.onLoad=function(){var e={red:{id:"red",spriteName:"red",behavior:new a.NormalBehavior},blue:{id:"blue",spriteName:"blue",behavior:new a.NormalBehavior},green:{id:"green",spriteName:"green",behavior:new a.NormalBehavior},purpure:{id:"purpure",spriteName:"purpure",behavior:new a.NormalBehavior},yellow:{id:"yellow",spriteName:"yellow",behavior:new a.NormalBehavior},bomb:{id:"bomb",spriteName:"bomb",behavior:new a.BombBehavior},roketV:{id:"roketV",spriteName:"roketV",behavior:new a.RoketVBehavior},roketH:{id:"roketH",spriteName:"roketH",behavior:new a.RoketHBehavior}};window.TileSpriteFrames={red:this.redSprite,blue:this.blueSprite,green:this.greenSprite,bomb:this.bombSprite,roketV:this.roketVSprite,roketH:this.roketHSprite,yellow:this.yellowSprite,purpure:this.purpureSprite},window.RocketPrefabs={up:this.rocketUpPrefab,down:this.rocketDownPrefab,left:this.rocketLeftPrefab,right:this.rocketRightPrefab},window.Fire={Fire:this.firePrefab},window.TileConfigs=e},n([l(cc.Prefab)],t.prototype,"rocketUpPrefab",void 0),n([l(cc.Prefab)],t.prototype,"rocketDownPrefab",void 0),n([l(cc.Prefab)],t.prototype,"rocketLeftPrefab",void 0),n([l(cc.Prefab)],t.prototype,"rocketRightPrefab",void 0),n([l(cc.Prefab)],t.prototype,"firePrefab",void 0),n([l(cc.SpriteFrame)],t.prototype,"redSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"blueSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"greenSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"bombSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"purpureSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"yellowSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"roketVSprite",void 0),n([l(cc.SpriteFrame)],t.prototype,"roketHSprite",void 0),n([s],t)}(cc.Component);o.default=u,cc._RF.pop()},{"../Core/Tiles/TileBehavior":"TileBehavior"}],TileAnimator:[function(e,t,o){"use strict";cc._RF.push(t,"a468eItbetHHqHN1tduHPOJ","TileAnimator");var r=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(t){n(t)}}function c(e){try{s(r.throw(e))}catch(t){n(t)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var o,r,i,n,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function c(e){return function(t){return s([e,t])}}function s(n){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(i=2&n[0]?r.return:n[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,n[1])).done)return i;switch(r=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){a.label=n[1];break}if(6===n[0]&&a.label<i[1]){a.label=i[1],i=n;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(n);break}i[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(c){n=[6,c],r=0}finally{o=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}};Object.defineProperty(o,"__esModule",{value:!0}),o.TileAnimator=void 0;var n=e("../../Infrastructure/Utils/AsyncUtils"),a=function(){function e(e,t,o){this.cellTime=.2,this.addRoketTime=.05,this.boardService=o,this.boardModel=t,this.boardView=e}return e.prototype.animateGroupRemoval=function(e,t){return r(this,void 0,void 0,function(){var o,r=this;return i(this,function(i){switch(i.label){case 0:return e.isSpecial||t.length<6?(o=t.map(function(e){return r.animateRemoval(e)}),[4,Promise.all(o)]):[3,2];case 1:return i.sent(),[3,4];case 2:return[4,this.animateRemovalCollection(e,t)];case 3:i.sent(),i.label=4;case 4:return[2]}})})},e.prototype.animateCollapse=function(){return r(this,void 0,void 0,function(){var e,t,o,r,n,a;return i(this,function(i){switch(i.label){case 0:for(e=new Map,o=0;o<this.boardModel.rows;o++)for(r=0;r<this.boardModel.cols;r++)(n=this.boardView.getTileNode(r,o))&&e.set(n,{x:r,y:o});for(this.boardView.updateTileNodesStructure(),t=[],o=0;o<this.boardModel.rows;o++)for(r=0;r<this.boardModel.cols;r++)(n=this.boardView.getTileNode(r,o))&&(a=e.get(n))&&a.y!==o&&t.push(this.tweenFall(n,r,a.y,r,o,16));return[4,Promise.all(t)];case 1:return i.sent(),[2]}})})},e.prototype.tweenFall=function(e,t,o,r,i,n){var a=Math.abs(o-i),c=a/n,s=this.boardView.getTilePosition(r,i);e.position=this.boardView.getTilePosition(t,o),e.zIndex=o,e.scale=1;var l=0===i?0:a>1?.05*(a-1):0;return new Promise(function(t){cc.tween(e).to(c,{position:s,zIndex:i}).to(.05,{position:cc.v3(s.x,s.y-5)},{easing:"quadOut"}).to(.08,{position:s},{easing:"bounceOut"}).delay(l).to(.05,{scaleX:1.15,scaleY:.85},{easing:"quadOut"}).to(.08,{scaleX:.95,scaleY:1.05},{easing:"quadOut"}).to(.06,{scaleX:1,scaleY:1},{easing:"quadOut"}).call(t).start()})},e.prototype.animateSpawn=function(e){var t;return r(this,void 0,Promise,function(){var o,r,n,a,c,s,l;return i(this,function(i){switch(i.label){case 0:for(o=e.map(function(e){return e.tile}),r=this.boardView.spawnTiles(o),n=[],a=0;a<e.length;a++)c=e[a].fromY,s=o[a],(l=null===(t=r[s.y])||void 0===t?void 0:t[s.x])?n.push(this.tweenFall(l,s.x,c,s.x,s.y,16)):console.warn("Node not found at position y="+s.y+", x="+s.x);return[4,Promise.all(n)];case 1:return i.sent(),[2]}})})},e.prototype.animateRemoval=function(e){return r(this,void 0,Promise,function(){var t,o;return i(this,function(r){switch(r.label){case 0:if(!e)return[2];if(!(t=this.boardView.getTileNode(e.x,e.y))||!t.isValid)return[2];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.runTweenAnimation(t)];case 2:return r.sent(),[3,4];case 3:return o=r.sent(),console.error("\u041e\u0448\u0438\u0431\u043a\u0430 \u0430\u043d\u0438\u043c\u0430\u0446\u0438\u0438 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u044f:",o),[3,4];case 4:return[2]}})})},e.prototype.runTweenAnimation=function(e){var t=this;return new Promise(function(o){if(!e||!e.isValid)return o(),void console.log("ERROR");cc.tween(e).to(t.cellTime,{scale:0,opacity:0}).call(function(){o()}).start()||o()})},e.prototype.animateRemovalCollection=function(e,t){return r(this,void 0,Promise,function(){var o,r,a,c,s,l,u=this;return i(this,function(i){switch(i.label){case 0:return o=t,r=e.x,a=e.y,c=this.boardView.getTilePosition(r,a),s=o.map(function(e){var t=u.boardView.getTileNode(e.x,e.y);if(!t)return Promise.resolve();var o=e.x-r,i=e.y-a,n=1.2*o,c=1.2*i,s=u.boardView.getTilePosition(r+n,a+c);return t.zIndex=1e3+Math.floor(Math.abs(o)+Math.abs(i)),new Promise(function(e){cc.tween(t).to(.1,{position:s,scale:1.021}).call(e).start()})}),[4,Promise.all(s)];case 1:return i.sent(),[4,n.delay(50)];case 2:return i.sent(),l=o.map(function(e){var t=u.boardView.getTileNode(e.x,e.y);return t?(t.zIndex=0,new Promise(function(o){cc.tween(t).to(.1,{position:c}).to(.1,{scale:0}).call(function(){t.destroy(),u.boardView.RemoveTileNode(e.x,e.y),o()}).start()})):Promise.resolve()}),[4,Promise.all(l)];case 3:return i.sent(),[2]}})})},e.prototype.animateSpawnSpecialTile=function(e){return r(this,void 0,void 0,function(){var t,o;return i(this,function(r){switch(r.label){case 0:return(t=this.boardService.createRandomSpecialTile(e.x,e.y))?((o=this.boardView.createTileNode(t,e.x,e.y)).scale=0,[4,new Promise(function(e){cc.tween(o).to(.3,{scale:1},{easing:"backOut"}).call(e).start()})]):[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}})})},e.prototype.animateRocketLaunch=function(e,t){return r(this,void 0,void 0,function(){var o,r,n,a,c,s,l,u,p,f,h,d,v,y,b,m,w,g,_,T=this;return i(this,function(i){switch(i.label){case 0:return o=this.boardView.getTilePosition(e.x,e.y),r=window.RocketPrefabs,n=function(e){var t=cc.instantiate(e);return t.position=o,t.parent=T.boardView.node,t.zIndex=9999,t},a=[],c=this.cellTime+this.addRoketTime,"vertical"===t?(s=this.boardModel.rows-1,l=n(r.up),u=s-e.y,p=this.boardView.getTilePosition(e.x,s),a.push(new Promise(function(e){cc.tween(l).to(u*c,{position:p}).call(function(){l.destroy(),e()}).start()})),f=n(r.down),h=e.y-0,d=this.boardView.getTilePosition(e.x,0),a.push(new Promise(function(e){cc.tween(f).to(h*c,{position:d}).call(function(){f.destroy(),e()}).start()}))):(v=this.boardModel.cols-1,y=n(r.right),b=v-e.x,m=this.boardView.getTilePosition(v,e.y),a.push(new Promise(function(e){cc.tween(y).to(b*c,{position:m}).call(function(){y.destroy(),e()}).start()})),w=n(r.left),g=e.x-0,_=this.boardView.getTilePosition(0,e.y),a.push(new Promise(function(e){cc.tween(w).to(g*c,{position:_}).call(function(){w.destroy(),e()}).start()}))),[4,Promise.all(a)];case 1:return i.sent(),[2]}})})},e.prototype.spawnFireAtTile=function(e){var t=this.boardView.getTilePosition(e.x,e.y),o=window.Fire.Fire,r=cc.instantiate(o);r.position=t,r.parent=this.boardView.node,r.zIndex=9994,cc.tween(r).to(2*this.cellTime,{opacity:0}).call(function(){r.destroy()}).start()},e}();o.TileAnimator=a,cc._RF.pop()},{"../../Infrastructure/Utils/AsyncUtils":"AsyncUtils"}],TileBehavior:[function(e,t,o){"use strict";cc._RF.push(t,"b8debIXSJBGz7fbx5J9G0wa","TileBehavior");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(t){n(t)}}function c(e){try{s(r.throw(e))}catch(t){n(t)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,c)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var o,r,i,n,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function c(e){return function(t){return s([e,t])}}function s(n){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(i=2&n[0]?r.return:n[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,n[1])).done)return i;switch(r=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){a.label=n[1];break}if(6===n[0]&&a.label<i[1]){a.label=i[1],i=n;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(n);break}i[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(c){n=[6,c],r=0}finally{o=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}},c=this&&this.__spreadArrays||function(){for(var e=0,t=0,o=arguments.length;t<o;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<o;t++)for(var n=arguments[t],a=0,c=n.length;a<c;a++,i++)r[i]=n[a];return r};Object.defineProperty(o,"__esModule",{value:!0}),o.RoketHBehavior=o.RoketVBehavior=o.BaseRoketBehavior=o.BombBehavior=o.NormalBehavior=o.ChainReactionBehavior=o.BaseTileBehavior=void 0;var s=e("../../Infrastructure/Utils/AsyncUtils"),l=function(){function e(){}return e.prototype.init=function(e,t){this.board=e,this.animator=t},e}();o.BaseTileBehavior=l;var u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t}(l);o.ChainReactionBehavior=u;var p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.execute=function(e){return n(this,void 0,Promise,function(){return a(this,function(t){switch(t.label){case 0:return this.getAffectedTiles(e).length>1?[4,this.playAnimation(e)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.getAffectedTiles=function(e){for(var t=new Set,o=[e],r=e.id;o.length;){var i=o.pop();if(!t.has(i)){t.add(i);for(var n=0,a=[[0,1],[0,-1],[1,0],[-1,0]];n<a.length;n++){var c=a[n],s=c[0],l=c[1],u=this.board.getTile(i.x+s,i.y+l);u&&u.id===r&&!t.has(u)&&o.push(u)}}}return Array.from(t).length>=2?Array.from(t):[]},t.prototype.playAnimation=function(e){return n(this,void 0,Promise,function(){var t;return a(this,function(o){switch(o.label){case 0:return t=this.getAffectedTiles(e),[4,this.animator.animateGroupRemoval(e,t)];case 1:return o.sent(),this.board.removeTiles(t),[4,this.animator.animateSpawnSpecialTile(e)];case 2:return o.sent(),[2]}})})},t}(l);o.NormalBehavior=p;var f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.execute=function(e){return n(this,void 0,Promise,function(){return a(this,function(t){switch(t.label){case 0:return e.isRemoved?[2]:[4,this.playAnimation(e)];case 1:return t.sent(),[2]}})})},t.prototype.playAnimation=function(e){return n(this,void 0,Promise,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.processBombRemoval(e)];case 1:return t.sent(),[2]}})})},t.prototype.processBombRemoval=function(e){return n(this,void 0,Promise,function(){var o,r,i,n,l,p,f,h,d,v,y,b;return a(this,function(a){switch(a.label){case 0:o=[e],r=new Set,a.label=1;case 1:if(!(o.length>0))return[3,5];for(i=[],n=[],l=[],p=0,f=o;p<f.length;p++)if(h=f[p],!r.has(h)){if(r.add(h),h.behavior instanceof t)for(d=h.behavior.getAffectedTiles(h),v=0,y=d;v<y.length;v++)(b=y[v])!==h&&(b.isRemoved||r.has(b)||i.includes(b)||b.behavior instanceof u&&i.push(b));h.behavior instanceof t?n.push(h):l.push(h)}return[4,Promise.all(c(n.map(function(e){return e.behavior.explodeWithoutKillingChains(e)}),l.map(function(e){return e.behavior.execute(e)})))];case 2:return a.sent(),i.length>0?[4,s.delay(50)]:[3,4];case 3:a.sent(),a.label=4;case 4:return o=i,[3,1];case 5:return[2]}})})},t.prototype.explodeWithoutKillingChains=function(e){return n(this,void 0,Promise,function(){var t,o,r,i,n;return a(this,function(a){switch(a.label){case 0:for(t=this.getAffectedTiles(e),o=t.filter(function(t){return!(t.behavior instanceof u)||t===e}),r=0,i=t;r<i.length;r++)n=i[r],this.animator.spawnFireAtTile(n);return[4,this.animator.animateGroupRemoval(e,o)];case 1:return a.sent(),this.board.removeTiles(o),[2]}})})},t.prototype.getAffectedTiles=function(e){for(var t=[],o=e.x,r=e.y,i=r-1;i<=r+1;i++)for(var n=o-1;n<=o+1;n++)if((n!==o||i!==r)&&n>=0&&n<this.board.cols()&&i>=0&&i<this.board.rows()){var a=n-o,c=i-r;a*a+c*c<=1&&t.push(this.board.getTile(n,i))}return t.push(e),t},t}(u);o.BombBehavior=f;var h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.playAnimation=function(e){return n(this,void 0,Promise,function(){var t,o;return a(this,function(r){switch(r.label){case 0:return t=this.getAffectedTiles(e),o="vertical",this instanceof v&&(o="horizontal"),[4,Promise.all([this.animator.animateRocketLaunch(e,o),this.processRocketRemoval(e,t)])];case 1:return r.sent(),this.board.removeTiles(t),[2]}})})},t.prototype.processRocketRemoval=function(e,t){return n(this,void 0,Promise,function(){var o,r,i,s,l,u=this;return a(this,function(p){switch(p.label){case 0:return o=t.findIndex(function(t){return t===e}),r=o-1,i=o+1,s=function(e){return new Promise(function(t){return setTimeout(t,e)})},[4,this.animator.animateRemoval(e)];case 1:return p.sent(),l=[],[4,n(u,void 0,void 0,function(){var o,n,u;return a(this,function(a){switch(a.label){case 0:return r>=0||i<t.length?(o=[],n=[],r>=0&&(this.collectStep(t[r],e,o,n),r--),i<t.length&&(this.collectStep(t[i],e,o,n),i++),u=n.map(function(e){return e.behavior.execute(e)}),l.push.apply(l,c(o,u)),[4,s(1e3*(this.animator.cellTime+this.animator.addRoketTime))]):[3,2];case 1:return a.sent(),[3,0];case 2:return[2]}})})];case 2:return p.sent(),[4,Promise.all(l)];case 3:return p.sent(),[2]}})})},t.prototype.collectStep=function(e,t,o,r){e&&(this.isChainReaction(t,e)?r.push(e):o.push(this.animator.animateRemoval(e)))},t.prototype.isChainReaction=function(e,t){return e.behavior.constructor!==t.behavior.constructor&&t.behavior instanceof u},t}(u);o.BaseRoketBehavior=h;var d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lineLocks=new Map,t}return i(t,e),t.prototype.execute=function(e){return n(this,void 0,Promise,function(){return a(this,function(t){switch(t.label){case 0:return e.isRemoved?[2]:this.lineLocks.get(e.x)?[4,this.animator.animateRemoval(e)]:[3,2];case 1:return t.sent(),[2];case 2:return this.lineLocks.set(e.x,!0),[4,this.playAnimation(e)];case 3:return t.sent(),this.lineLocks.set(e.x,!1),[2]}})})},t.prototype.getAffectedTiles=function(e){for(var t=[],o=0;o<this.board.rows();o++){var r=this.board.getTile(e.x,o);r&&t.push(r)}return t},t}(h);o.RoketVBehavior=d;var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lineLocks=new Map,t}return i(t,e),t.prototype.execute=function(e){return n(this,void 0,Promise,function(){return a(this,function(t){switch(t.label){case 0:return e.isRemoved?[2]:this.lineLocks.get(e.y)?[4,this.animator.animateRemoval(e)]:[3,2];case 1:return t.sent(),[2];case 2:return this.lineLocks.set(e.y,!0),[4,this.playAnimation(e)];case 3:return t.sent(),this.lineLocks.set(e.y,!1),[2]}})})},t.prototype.getAffectedTiles=function(e){for(var t=[],o=0;o<this.board.cols();o++){var r=this.board.getTile(o,e.y);r&&t.push(r)}return t},t}(h);o.RoketHBehavior=v,cc._RF.pop()},{"../../Infrastructure/Utils/AsyncUtils":"AsyncUtils"}],TileConfig:[function(e,t,o){"use strict";cc._RF.push(t,"5d8a6eKkIhKQLew0i7E3b+i","TileConfig"),Object.defineProperty(o,"__esModule",{value:!0}),cc._RF.pop()},{}],TileFactory:[function(e,t,o){"use strict";cc._RF.push(t,"642f27c15dBYbZgTPmWc4Rr","TileFactory"),Object.defineProperty(o,"__esModule",{value:!0}),o.TileFactory=void 0;var r=e("./TileModel"),i=e("./TileBehavior"),n=function(){function e(e){void 0===e&&(e={}),this.configs=e}return e.prototype.logWithStack=function(e){var t=(new Error).stack;console.log(e,"\nCall stack:",t)},e.prototype.create=function(e,t,o,n){var a,c=null!=n?n:this.getRandomNormalKey(),s=this.configs[c],l=null!==(a=null==s?void 0:s.behavior)&&void 0!==a?a:new i.NormalBehavior;return new r.TileModel(c,e,t,o,l)},e.prototype.getRandomNormalKey=function(){var e,t=this,o=Object.keys(this.configs).filter(function(e){return t.configs[e].behavior,!0});return 0===o.length?null!==(e=Object.keys(this.configs)[0])&&void 0!==e?e:"normal":o[Math.floor(Math.random()*o.length)]},e.prototype.createRandomSpecial=function(e,t){var o=this,r=["bomb","roketH","roketV"].filter(function(e){return!!o.configs[e]});if(0===r.length)return null;var i=r[Math.floor(Math.random()*r.length)];return this.create(e,t,!0,i)},e}();o.TileFactory=n,cc._RF.pop()},{"./TileBehavior":"TileBehavior","./TileModel":"TileModel"}],TileModel:[function(e,t,o){"use strict";cc._RF.push(t,"ad134aCTvpJsZLN2wBBpxAF","TileModel"),Object.defineProperty(o,"__esModule",{value:!0}),o.TileModel=void 0;o.TileModel=function(e,t,o,r,i){void 0===i&&(i=null),this.id=e,this.x=t,this.y=o,this.isSpecial=r,this.behavior=i,this.isRemoved=!1},cc._RF.pop()},{}],TileView:[function(e,t,o){"use strict";cc._RF.push(t,"0f4ff2EiAJLK7EUQzqtBnPv","TileView");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(o,"__esModule",{value:!0});var a=cc._decorator,c=a.ccclass,s=a.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.sprite=null,t.model=null,t.controller=null,t}return i(t,e),t.prototype.logWithStack=function(e){var t=(new Error).stack;console.log(e,"\nCall stack:",t)},t.prototype.bindModel=function(e,t,o){this.model=e,this.controller=t,o&&this.sprite&&(this.sprite.spriteFrame=o),this.node.name="tile_"+e.x+"_"+e.y},t.prototype.onLoad=function(){this.node.on(cc.Node.EventType.TOUCH_END,this.onClick,this)},t.prototype.onDestroy=function(){this.node.off(cc.Node.EventType.TOUCH_END,this.onClick,this)},t.prototype.onClick=function(){this.controller.onTileClicked(this.model)},t.prototype.setPositionByBoard=function(e,t,o){this.node.position=o(e,t)},n([s(cc.Sprite)],t.prototype,"sprite",void 0),n([c],t)}(cc.Component);o.default=l,cc._RF.pop()},{}],UIManager:[function(e,t,o){"use strict";cc._RF.push(t,"7b853JVacdNOKJZAxFoOalc","UIManager");var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),n=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(n<3?i(a):n>3?i(t,o,a):i(t,o))||a);return n>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(o,"__esModule",{value:!0});var a=cc._decorator,c=a.ccclass,s=a.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.scoreLabel=null,t}return i(t,e),t.prototype.setScore=function(e){this.scoreLabel&&(this.scoreLabel.string=String(e))},n([s(cc.Label)],t.prototype,"scoreLabel",void 0),n([c],t)}(cc.Component);o.default=l,cc._RF.pop()},{}]},{},["BoardModel","BoardService","GameModel","GameService","GameTypes","ScoreModel","ScoreService","TileBehavior","TileFactory","TileModel","GameConfig","TileConfig","AsyncUtils","TileAnimator","GameManager","ScriptableTileConfig","UIManager","BoardView","GameView","TileView"]);